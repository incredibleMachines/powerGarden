<!DOCTYPE html>
<html>
	<head>
		<script src="socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-2.0.2.min.js"></script>
		<script>
			var connections = [];

			function populate(connection_id,device_id,socket){
				
					if( $.inArray(device_id, connections) == -1 ){
						connections.push(device_id);
						var deviceControl = false;
						var html = '<section class="client-'+connection_id+'" data-connection="'+connection_id+'" data-device="'+device_id+'">';
							html+= '<h4>Device ID:</h4>';
							html+= '<p>'+device_id+'</p>';
							html+= '<p>Range Threshold:</p>';
							html+= '<p><input class="range client-'+connection_id+'" type="range" data-plant_index="'+i+'" min="0" max="15000"/>';
							html+= '<p><button class="control client-'+connection_id+'" type="button">Control On</button></p>';

						for(var i = 0; i<8; i++){
							html+= '<article> <p>Plant '+i+'</p>';
							html+= '<p><input class="plant-'+i+' cap client-'+connection_id+'" type="range" data-plant_index="'+i+'" min="0" max="15000"/>'; 
							html+= '<button class="plant-'+i+' disablePlant client-'+connection_id+'" data-ignore="false" data-plant_index="'+i+'" type="button">disable</button></p>';
							html+= '<p class="plant-'+i+' value client-'+connection_id+'">7500</p>'
							html+= '<p class="plant-'+i+' incoming client-'+connection_id+'">Nothing</p>'
							html+= '</article>';
						}

							html+= '</section>';
						
						$('body').append(html);	
						
						$('input.cap.client-'+connection_id).on( "change",function(){
							//console.log('slide');
							var val = $(this).val();
							$(this).parent().parent().find('.value').html(val);
							var connection = $(this).parent().parent().parent().data('connection');
							var device = $(this).parent().parent().parent().data('device');
							var plant = $(this).data('plant_index');
							var json = { value:val, type:'cap', connection_id:connection, device_id:device, plant_index: plant};
							socket.emit('threshold', json);
						});
						
						$('input.range.client-'+connection_id).on( "change",function(){
							var val = $(this).val();
							var connection = $(this).parent().parent().data('connection');
							var device = $(this).parent().parent().data('device');
							var json = { value:val, type:'range', connection_id:connection, device_id:device};
							socket.emit('threshold', json);

						});
						
						$('button.control.client-'+connection_id).on( "click", function(){ 
							deviceControl = !deviceControl; 
							if(!deviceControl) $(this).html('Control On');
							else $(this).html('Control Off');
							var connection = $(this).parent().parent().data('connection');
							var device = $(this).parent().parent().data('device');
							socket.emit('control', {device_id:device, connection_id:connection, stream:deviceControl });
						});
						
						$('button.disablePlant.client-'+connection_id).on("click",function(){
							//console.log( $(this).data('plant_index') );
							var index = $(this).data('plant_index');
							var bool = $(this).data('ignore');
							bool = !bool;
							$(this).data('ignore',bool);
							var connection = $(this).parent().parent().parent().data('connection');
							var device = $(this).parent().parent().parent().data('device');
							if(!bool) $(this).html('Disable');
							else $(this).html('Enable');
							
							socket.emit('ignore', {	device_id:device, connection_id:connection, plant_index:index, ignore:bool});

							
						});					
					}
					
			}
		
		
			$(document).ready(function(){
				var socket = io.connect('http://localhost:8080');
				socket.on('init', function(data){

					populate(data.connection_id,data.device_id,socket);
					
				});
				socket.on('device_conn', function(data){
				
					populate(data.connection_id,data.device_id,socket);

				});
				
				socket.on('device_disconn',function(data){
					console.log(data);
					//console.log(connections);
					$('.client-'+data.connection_id).remove();
					for(var i = 0; i< connections.length;i++){
						if(connections[i]== data.device_id){
							//connections[i]
							connections.splice(i,1);
							break;
						}
					}
					//console.log(connections);
				});
				socket.on('control',function(data){
					var $elem = $('button.control.client-'+data.connection_id);
					if(!data.stream) $elem.html('Control On');
					else $elem.html('Control Off');
					
					//console.log(data);
				});
				socket.on('ignore',function(data){
					//console.log(data);
					
					var $elem = $('button.plant-'+data.plant_index+'.disablePlant.client-'+data.connection_id);
					if(!data.ignore) $elem.html('Disable');
					else $elem.html('Enable');
					$elem.data('ignore',data.ignore);
					
				});
				socket.on('threshold',function(data){
					//console.log(data);
					
					if(data.type=='cap'){
						$('input.plant-'+data.plant_index+'.cap.client-'+data.connection_id).val(data.value);
						$('p.plant-'+data.plant_index+'.value.client-'+data.connection_id).html(data.value);

					}else if(data.type=='range'){
						$('input.range.client-'+data.connection_id).val(data.value);

					}
				});
				socket.on('stream',function(data){
					//console.log(data);
					
					//$("section."+data.connection_id)
					
					$.each(data.cap_val, function(key, val){
					
						$('.plant-'+key+'.incoming.client-'+data.connection_id).html(val);
						
					});
					
				});
				socket.on('disconnect',function(data){
					$('body').html(' ');
				});
				
				
				
			});
		</script>
	</head>
	<body>
	
	</body>
</html>