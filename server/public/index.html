<!DOCTYPE html>
<html>
	<head>
		<script src="socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-2.0.2.min.js"></script>
		<script>
			var connections = [];

			function populate(connection_id,device_id,socket){
				
					if( $.inArray(device_id, connections) == -1 ){
						connections.push(device_id);
						
						var html = '<section class="client-'+connection_id+'" data-connection="'+connection_id+'" data-device="'+device_id+'">';
						html+= '<h4>Device ID:</h4>';
						html+= '<p>'+device_id+'</p>';
						
						for(var i = 0; i<8; i++){
							html+= '<article> <p>Plant '+i+'</p>';
							html+= '<p><input class="plant-'+i+' slider client-'+connection_id+'" type="range" data-plant_index="'+i+'" min="0" max="15000"/></p>';
							html+= '<p class="value">7500</p>'
							html+= '</article>';
							
						}

						html+= '<button class="send client-'+connection_id+'" type="button">Send</button>';
						html+= '</section>';
						
						$('body').append(html);	
						$('input.slider.client-'+connection_id).on( "change",function(){
							//console.log('slide');
							var val = $(this).val();
							$(this).parent().parent().find('.value').html(val);
							var connection = $(this).parent().parent().parent().data('connection');
							var device = $(this).parent().parent().parent().data('device');
							var plant = $(this).data('plant_index');
							var json = { value:val, connection_id:connection, device_id:device, plant_index: plant};
							//console.log(json);
							socket.emit('update_touch', json);
						});
						
						$('button.send.client-'+connection_id).on( "click", function(){ 
							console.log('here'); 
						});					
					}
					
			}
		
		
			$(document).ready(function(){
				var socket = io.connect('http://localhost:8080');
				socket.on('init', function(data){

					populate(data.connection_id,data.device_id,socket);
					
				});
				socket.on('device_conn', function(data){
				
					populate(data.connection_id,data.device_id,socket);

				});
				
				socket.on('device_disconn',function(data){
					console.log(data);
					console.log(connections);
					$('.client-'+data.connection_id).remove();
					for(var i = 0; i< connections.length;i++){
						if(connections[i]== data.device_id){
							//connections[i]
							connections.splice(i,1);
							break;
						}
					}
					console.log(connections);
				});
				
			});
		</script>
	</head>
	<body>
	
	</body>
</html>